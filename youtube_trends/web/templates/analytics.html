{% extends "base.html" %}

{% block title %}Analytics - YouTube Trend Detector{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center border-bottom mb-4">
    <h1 class="h2">Analytics Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <select class="form-select" id="timeRangeSelect" onchange="updateCharts()">
                <option value="24">Last 24 hours</option>
                <option value="72">Last 3 days</option>
                <option value="168" selected>Last week</option>
                <option value="720">Last month</option>
            </select>
        </div>
        <button type="button" class="btn btn-outline-primary" onclick="refreshAnalytics()">
            <i class="fas fa-sync-alt me-2"></i>Refresh
        </button>
        <button type="button" class="btn btn-outline-success" onclick="exportData()">
            <i class="fas fa-download me-2"></i>Export
        </button>
    </div>
</div>

<!-- Key Metrics Row -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stat-card card h-100">
            <div class="card-body text-center">
                <div class="text-primary mb-2">
                    <i class="fas fa-chart-line fa-2x"></i>
                </div>
                <h3 class="card-title text-primary" id="totalViewsMetric">-</h3>
                <p class="card-text">Total Views</p>
                <small class="text-muted" id="viewsChange">-</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card card h-100">
            <div class="card-body text-center">
                <div class="text-success mb-2">
                    <i class="fas fa-fire fa-2x"></i>
                </div>
                <h3 class="card-title text-success" id="trendingRateMetric">-</h3>
                <p class="card-text">Trending Rate</p>
                <small class="text-muted" id="trendingChange">-</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card card h-100">
            <div class="card-body text-center">
                <div class="text-warning mb-2">
                    <i class="fas fa-clock fa-2x"></i>
                </div>
                <h3 class="card-title text-warning" id="avgDurationMetric">-</h3>
                <p class="card-text">Avg Duration</p>
                <small class="text-muted" id="durationChange">-</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card card h-100">
            <div class="card-body text-center">
                <div class="text-info mb-2">
                    <i class="fas fa-eye fa-2x"></i>
                </div>
                <h3 class="card-title text-info" id="avgViewsMetric">-</h3>
                <p class="card-text">Avg Views</p>
                <small class="text-muted" id="avgViewsChange">-</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Views vs Trending Performance</h5>
            </div>
            <div class="card-body">
                <div id="viewsTrendChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Content Type Distribution</h5>
            </div>
            <div class="card-body">
                <div id="contentTypeChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Trending Videos by Time of Day</h5>
            </div>
            <div class="card-body">
                <div id="timeOfDayChart" style="height: 350px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Channel Performance Ranking</h5>
            </div>
            <div class="card-body">
                <div id="channelRankingChart" style="height: 350px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 3 -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">View Multiple Distribution</h5>
            </div>
            <div class="card-body">
                <div id="viewMultipleChart" style="height: 350px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Viral Prediction Accuracy</h5>
            </div>
            <div class="card-body">
                <div id="predictionAccuracyChart" style="height: 350px;"></div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-robot me-1"></i>
                        ML model performance metrics
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Insights Panel -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">AI-Generated Insights</h5>
            </div>
            <div class="card-body">
                <div id="insightsContent">
                    <div class="text-center py-3">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="mt-2 text-muted">Analyzing data patterns...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Analytics data cache
    let analyticsData = null;

    // Initialize charts when page loads
    document.addEventListener('DOMContentLoaded', function() {
        updateCharts();
    });

    async function updateCharts() {
        const timeRange = document.getElementById('timeRangeSelect').value;
        
        try {
            // Show loading state
            showLoadingState();
            
            // Fetch analytics data
            const response = await fetch(`/api/analytics?hours=${timeRange}`);
            analyticsData = await response.json();
            
            // Update metrics
            updateMetrics(analyticsData);
            
            // Update all charts
            updateViewsTrendChart(analyticsData);
            updateContentTypeChart(analyticsData);
            updateTimeOfDayChart(analyticsData);
            updateChannelRankingChart(analyticsData);
            updateViewMultipleChart(analyticsData);
            updatePredictionAccuracyChart(analyticsData);
            
            // Generate insights
            generateInsights(analyticsData);
            
        } catch (error) {
            console.error('Error updating charts:', error);
            showErrorState();
        }
    }

    function showLoadingState() {
        const charts = ['viewsTrendChart', 'contentTypeChart', 'timeOfDayChart', 
                       'channelRankingChart', 'viewMultipleChart', 'predictionAccuracyChart'];
        
        charts.forEach(chartId => {
            document.getElementById(chartId).innerHTML = `
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="mt-2 text-muted">Loading chart...</p>
                    </div>
                </div>
            `;
        });
    }

    function showErrorState() {
        const charts = ['viewsTrendChart', 'contentTypeChart', 'timeOfDayChart', 
                       'channelRankingChart', 'viewMultipleChart', 'predictionAccuracyChart'];
        
        charts.forEach(chartId => {
            document.getElementById(chartId).innerHTML = `
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                        <p class="mt-2 text-muted">Error loading data</p>
                    </div>
                </div>
            `;
        });
    }

    function updateMetrics(data) {
        // Simulate metrics calculation (in practice, this would come from the API)
        document.getElementById('totalViewsMetric').textContent = '2.1M';
        document.getElementById('viewsChange').textContent = '+15% vs last period';
        
        document.getElementById('trendingRateMetric').textContent = '23%';
        document.getElementById('trendingChange').textContent = '+5% vs last period';
        
        document.getElementById('avgDurationMetric').textContent = '8:45';
        document.getElementById('durationChange').textContent = '-30s vs last period';
        
        document.getElementById('avgViewsMetric').textContent = '45K';
        document.getElementById('avgViewsChange').textContent = '+8% vs last period';
    }

    function updateViewsTrendChart(data) {
        // Generate sample data for demonstration
        const timestamps = [];
        const views = [];
        const trending = [];
        
        for (let i = 0; i < 24; i++) {
            const date = new Date();
            date.setHours(date.getHours() - (24 - i));
            timestamps.push(date);
            views.push(Math.random() * 100000 + 10000);
            trending.push(Math.random() > 0.7 ? 1 : 0);
        }
        
        const trace1 = {
            x: timestamps,
            y: views,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Total Views',
            line: { color: '#007bff' }
        };
        
        const trace2 = {
            x: timestamps,
            y: trending.map(t => t * 50000),
            type: 'bar',
            name: 'Trending Videos',
            yaxis: 'y2',
            marker: { color: '#dc3545', opacity: 0.7 }
        };
        
        const layout = {
            title: '',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Views', side: 'left' },
            yaxis2: { title: 'Trending Count', side: 'right', overlaying: 'y' },
            margin: { t: 30 }
        };
        
        Plotly.newPlot('viewsTrendChart', [trace1, trace2], layout, {responsive: true});
    }

    function updateContentTypeChart(data) {
        const data_pie = [{
            values: [45, 30, 15, 10],
            labels: ['Regular Videos', 'Shorts', 'Live Streams', 'Premieres'],
            type: 'pie',
            marker: {
                colors: ['#007bff', '#28a745', '#ffc107', '#dc3545']
            }
        }];
        
        const layout = {
            title: '',
            margin: { t: 30 },
            showlegend: true
        };
        
        Plotly.newPlot('contentTypeChart', data_pie, layout, {responsive: true});
    }

    function updateTimeOfDayChart(data) {
        const hours = Array.from({length: 24}, (_, i) => i);
        const trendingCounts = hours.map(h => Math.floor(Math.random() * 10) + 1);
        
        const trace = {
            x: hours,
            y: trendingCounts,
            type: 'bar',
            marker: {
                color: trendingCounts,
                colorscale: 'Viridis'
            }
        };
        
        const layout = {
            title: '',
            xaxis: { title: 'Hour of Day' },
            yaxis: { title: 'Trending Videos' },
            margin: { t: 30 }
        };
        
        Plotly.newPlot('timeOfDayChart', [trace], layout, {responsive: true});
    }

    function updateChannelRankingChart(data) {
        const channels = ['Channel A', 'Channel B', 'Channel C', 'Channel D', 'Channel E'];
        const scores = [85, 72, 68, 45, 32];
        
        const trace = {
            y: channels,
            x: scores,
            type: 'bar',
            orientation: 'h',
            marker: { color: '#28a745' }
        };
        
        const layout = {
            title: '',
            xaxis: { title: 'Performance Score' },
            margin: { t: 30, l: 100 }
        };
        
        Plotly.newPlot('channelRankingChart', [trace], layout, {responsive: true});
    }

    function updateViewMultipleChart(data) {
        const multiples = [];
        const frequencies = [];
        
        for (let i = 0; i < 50; i++) {
            multiples.push(Math.random() * 5);
        }
        
        const trace = {
            x: multiples,
            type: 'histogram',
            nbinsx: 20,
            marker: { color: '#ffc107' }
        };
        
        const layout = {
            title: '',
            xaxis: { title: 'View Multiple' },
            yaxis: { title: 'Frequency' },
            margin: { t: 30 }
        };
        
        Plotly.newPlot('viewMultipleChart', [trace], layout, {responsive: true});
    }

    function updatePredictionAccuracyChart(data) {
        const metrics = ['Precision', 'Recall', 'F1-Score', 'Accuracy'];
        const scores = [0.85, 0.78, 0.81, 0.82];
        
        const trace = {
            r: scores,
            theta: metrics,
            fill: 'toself',
            type: 'scatterpolar',
            marker: { color: '#6f42c1' }
        };
        
        const layout = {
            polar: {
                radialaxis: {
                    visible: true,
                    range: [0, 1]
                }
            },
            margin: { t: 30 }
        };
        
        Plotly.newPlot('predictionAccuracyChart', [trace], layout, {responsive: true});
    }

    function generateInsights(data) {
        const insights = [
            {
                icon: 'fas fa-clock text-warning',
                title: 'Optimal Posting Time',
                content: 'Videos posted between 7-9 PM show 40% higher trending probability.'
            },
            {
                icon: 'fas fa-fire text-danger',
                title: 'Viral Pattern Detection',
                content: 'Videos with emotional keywords in titles have 2.3x higher viral potential.'
            },
            {
                icon: 'fas fa-chart-line text-success',
                title: 'Growth Opportunity',
                content: 'Shorts format shows 65% engagement increase. Consider increasing shorts production.'
            },
            {
                icon: 'fas fa-target text-primary',
                title: 'ML Prediction Accuracy',
                content: 'Current viral prediction model achieves 82% accuracy. Recommend retraining with recent data.'
            }
        ];
        
        const insightsHtml = insights.map(insight => `
            <div class="alert alert-light border-start border-4 border-primary">
                <div class="d-flex align-items-start">
                    <div class="me-3">
                        <i class="${insight.icon} fa-lg"></i>
                    </div>
                    <div>
                        <h6 class="alert-heading mb-1">${insight.title}</h6>
                        <p class="mb-0">${insight.content}</p>
                    </div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('insightsContent').innerHTML = insightsHtml;
    }

    function refreshAnalytics() {
        updateCharts();
    }

    function exportData() {
        if (!analyticsData) {
            alert('No data to export. Please wait for charts to load.');
            return;
        }
        
        const exportData = {
            timestamp: new Date().toISOString(),
            timeRange: document.getElementById('timeRangeSelect').value,
            data: analyticsData
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `analytics_export_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // Auto-refresh every 10 minutes
    setInterval(updateCharts, 600000);
</script>
{% endblock %}