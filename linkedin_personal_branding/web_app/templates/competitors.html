{% extends "base.html" %}

{% block title %}Competitor Analysis - LinkedIn Personal Branding{% endblock %}

{% block header %}Competitor Analysis{% endblock %}
{% block subtitle %}Track and analyze your LinkedIn competitors to stay ahead{% endblock %}

{% block content %}

<!-- Analytics Overview -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-6 rounded-lg">
        <div class="flex items-center justify-between">
            <div>
                <div class="text-2xl font-bold">{{ analytics.total_competitors }}</div>
                <div class="text-red-100">Competitors Tracked</div>
            </div>
            <i class="fas fa-users text-3xl text-red-200"></i>
        </div>
    </div>
    
    <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-lg">
        <div class="flex items-center justify-between">
            <div>
                <div class="text-2xl font-bold">{{ analytics.avg_connections }}</div>
                <div class="text-orange-100">Avg Connections</div>
            </div>
            <i class="fas fa-link text-3xl text-orange-200"></i>
        </div>
    </div>
    
    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg">
        <div class="flex items-center justify-between">
            <div>
                <div class="text-2xl font-bold">{{ analytics.top_performer.connections if analytics.top_performer else 0 }}</div>
                <div class="text-green-100">Top Performer</div>
            </div>
            <i class="fas fa-trophy text-3xl text-green-200"></i>
        </div>
    </div>
    
    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg">
        <div class="flex items-center justify-between">
            <div>
                <div class="text-2xl font-bold">{{ analytics.last_updated }}</div>
                <div class="text-purple-100">Last Update</div>
            </div>
            <i class="fas fa-clock text-3xl text-purple-200"></i>
        </div>
    </div>
</div>

<!-- Actions Bar -->
<div class="flex flex-wrap justify-between items-center mb-6 gap-4">
    <div class="flex items-center space-x-4">
        <h2 class="text-xl font-semibold text-gray-900">Your Competitors</h2>
        <span class="bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded">
            {{ competitors|length }} tracked
        </span>
    </div>
    
    <div class="flex space-x-3">
        <a href="/competitors/feed" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
            <i class="fas fa-stream mr-2"></i>
            View All Posts
        </a>
        <button onclick="refreshAllCompetitors()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
            <i class="fas fa-sync-alt mr-2"></i>
            Refresh All Data
        </button>
        <button onclick="exportCompetitors()" class="btn-secondary">
            <i class="fas fa-download mr-2"></i>
            Export Analysis
        </button>
        <button onclick="openAddCompetitorModal()" class="btn-primary">
            <i class="fas fa-plus mr-2"></i>
            Add Competitor
        </button>
    </div>
</div>

<!-- Competitors List -->
<div id="competitors-container" class="space-y-6">
    {% if competitors %}
        {% for competitor in competitors %}
        <div class="competitor-card bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
            <!-- Competitor Header -->
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xl font-bold">
                        {{ competitor.name[:2].upper() }}
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">{{ competitor.name }}</h3>
                        <p class="text-gray-600">{{ competitor.headline[:80] }}{% if competitor.headline|length > 80 %}...{% endif %}</p>
                        <div class="flex items-center space-x-4 text-sm text-gray-500 mt-1">
                            <span class="flex items-center">
                                <i class="fas fa-calendar mr-1"></i>
                                Added {{ competitor.added_date[:10] }}
                            </span>
                            {% if competitor.last_scraped %}
                            <span class="flex items-center">
                                <i class="fas fa-sync mr-1"></i>
                                Updated {{ competitor.last_scraped[:10] }}
                            </span>
                            {% endif %}
                            <a href="{{ competitor.linkedin_url }}" target="_blank" class="flex items-center text-blue-600 hover:text-blue-800">
                                <i class="fab fa-linkedin mr-1"></i>
                                View Profile
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex items-center space-x-2">
                    <a href="/competitors/{{ competitor.id }}/details" class="text-purple-600 hover:text-purple-800 p-2" title="View Details & Posts">
                        <i class="fas fa-eye"></i>
                    </a>
                    <button onclick="scrapeCompetitorPosts('{{ competitor.id }}')" class="text-orange-600 hover:text-orange-800 p-2" title="Scrape Posts">
                        <i class="fas fa-newspaper"></i>
                    </button>
                    <button onclick="refreshCompetitor('{{ competitor.id }}')" class="text-green-600 hover:text-green-800 p-2" title="Refresh Data">
                        <i class="fas fa-sync"></i>
                    </button>
                    <button onclick="viewInsights('{{ competitor.id }}')" class="text-blue-600 hover:text-blue-800 p-2" title="View Insights">
                        <i class="fas fa-chart-line"></i>
                    </button>
                    <button onclick="editCompetitor('{{ competitor.id }}')" class="text-gray-600 hover:text-gray-800 p-2" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteCompetitor('{{ competitor.id }}')" class="text-red-600 hover:text-red-800 p-2" title="Remove">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- Metrics Grid -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                <div class="text-center p-3 bg-gray-50 rounded">
                    <div class="text-lg font-semibold text-gray-900">{{ competitor.metrics.connections or 'N/A' }}</div>
                    <div class="text-sm text-gray-600">Connections</div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded">
                    <div class="text-lg font-semibold text-gray-900">{{ competitor.metrics.followers or 'N/A' }}</div>
                    <div class="text-sm text-gray-600">Followers</div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded">
                    <div class="text-lg font-semibold text-gray-900">{{ competitor.metrics.posts_count or 'N/A' }}</div>
                    <div class="text-sm text-gray-600">Posts</div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded">
                    <div class="text-lg font-semibold text-gray-900">{{ competitor.metrics.engagement_rate or 'N/A' }}%</div>
                    <div class="text-sm text-gray-600">Engagement</div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded">
                    <div class="text-lg font-semibold 
                           {% if competitor.metrics.growth_trend == 'up' %}text-green-600
                           {% elif competitor.metrics.growth_trend == 'down' %}text-red-600
                           {% else %}text-gray-600{% endif %}">
                        <i class="fas fa-arrow-{% if competitor.metrics.growth_trend == 'up' %}up{% elif competitor.metrics.growth_trend == 'down' %}down{% else %}right{% endif %} mr-1"></i>
                        {{ competitor.metrics.growth_rate or '0' }}%
                    </div>
                    <div class="text-sm text-gray-600">Growth</div>
                </div>
            </div>
            
            <!-- Comparison vs You -->
            <div class="border-t pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Comparison vs Your Profile</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Connections:</span>
                        <span class="text-sm font-medium 
                               {% if competitor.comparison.connections_diff > 0 %}text-red-600
                               {% elif competitor.comparison.connections_diff < 0 %}text-green-600
                               {% else %}text-gray-600{% endif %}">
                            {% if competitor.comparison.connections_diff > 0 %}+{% endif %}{{ competitor.comparison.connections_diff or 0 }}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Followers:</span>
                        <span class="text-sm font-medium 
                               {% if competitor.comparison.followers_diff > 0 %}text-red-600
                               {% elif competitor.comparison.followers_diff < 0 %}text-green-600
                               {% else %}text-gray-600{% endif %}">
                            {% if competitor.comparison.followers_diff > 0 %}+{% endif %}{{ competitor.comparison.followers_diff or 0 }}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Activity:</span>
                        <span class="text-sm font-medium 
                               {% if competitor.comparison.activity_diff > 0 %}text-red-600
                               {% elif competitor.comparison.activity_diff < 0 %}text-green-600
                               {% else %}text-gray-600{% endif %}">
                            {% if competitor.comparison.activity_diff > 0 %}+{% endif %}{{ competitor.comparison.activity_diff or 0 }}%
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Insights -->
            {% if competitor.insights %}
            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                <h4 class="text-sm font-medium text-blue-900 mb-1">Key Insights</h4>
                <ul class="text-sm text-blue-800 space-y-1">
                    {% for insight in competitor.insights[:3] %}
                    <li>â€¢ {{ insight }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
            <div class="max-w-md mx-auto">
                <i class="fas fa-users text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No competitors tracked yet</h3>
                <p class="text-gray-600 mb-6">Start tracking your LinkedIn competitors to gain insights into their strategies, growth patterns, and content performance.</p>
                <button onclick="openAddCompetitorModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    Add Your First Competitor
                </button>
            </div>
        </div>
    {% endif %}
</div>

<!-- Add/Edit Competitor Modal -->
<div id="competitorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center h-full p-4">
        <div class="bg-white rounded-lg w-full max-w-lg">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold" id="competitorModalTitle">Add Competitor</h3>
                    <button onclick="closeCompetitorModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="competitorForm" class="space-y-4">
                    <input type="hidden" id="competitorId" value="">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">LinkedIn Profile URL*</label>
                        <input type="url" id="competitorUrl" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                               placeholder="https://linkedin.com/in/competitor-profile" required>
                        <p class="text-xs text-gray-500 mt-1">Enter the full LinkedIn profile URL</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Competitor Name</label>
                        <input type="text" id="competitorName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                               placeholder="John Doe (auto-filled from profile)">
                        <p class="text-xs text-gray-500 mt-1">Will be auto-filled when profile is scraped</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Industry/Category</label>
                        <select id="competitorCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select category...</option>
                            <option value="ai_automation">AI & Automation</option>
                            <option value="cybersecurity">Cybersecurity</option>
                            <option value="software_dev">Software Development</option>
                            <option value="consulting">Consulting</option>
                            <option value="startup">Startup/Entrepreneur</option>
                            <option value="corporate">Corporate Executive</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tracking Priority</label>
                        <select id="competitorPriority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="high">High - Weekly tracking</option>
                            <option value="medium" selected>Medium - Bi-weekly tracking</option>
                            <option value="low">Low - Monthly tracking</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                        <textarea id="competitorNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                  placeholder="Why are you tracking this competitor? What makes them interesting?"></textarea>
                    </div>
                </form>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="closeCompetitorModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        Cancel
                    </button>
                    <button onclick="saveCompetitor()" class="btn-primary">
                        <i class="fas fa-plus mr-2"></i>
                        Add Competitor
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Competitor Insights Modal -->
<div id="insightsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center h-full p-4">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-96vh overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold" id="insightsTitle">Competitor Insights</h3>
                    <button onclick="closeInsightsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="insightsContent">
                    <!-- Dynamic content loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.competitor-card {
    transition: all 0.3s ease;
}

.competitor-card:hover {
    transform: translateY(-2px);
}

.max-h-96vh {
    max-height: 96vh;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Add competitor modal
function openAddCompetitorModal() {
    document.getElementById('competitorModalTitle').textContent = 'Add Competitor';
    document.getElementById('competitorId').value = '';
    document.getElementById('competitorForm').reset();
    document.getElementById('competitorModal').classList.remove('hidden');
}

function closeCompetitorModal() {
    document.getElementById('competitorModal').classList.add('hidden');
}

function closeInsightsModal() {
    document.getElementById('insightsModal').classList.add('hidden');
}

// Save competitor
function saveCompetitor() {
    const competitorId = document.getElementById('competitorId').value;
    const isEdit = competitorId !== '';
    
    const competitorData = {
        linkedin_url: document.getElementById('competitorUrl').value,
        name: document.getElementById('competitorName').value,
        category: document.getElementById('competitorCategory').value,
        priority: document.getElementById('competitorPriority').value,
        notes: document.getElementById('competitorNotes').value
    };
    
    if (!competitorData.linkedin_url) {
        showToast('LinkedIn URL is required', 'error');
        return;
    }
    
    const url = isEdit ? `/api/competitors/${competitorId}` : '/api/competitors';
    const method = isEdit ? 'PUT' : 'POST';
    
    // Show loading state
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';
    button.disabled = true;
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(competitorData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Competitor ${isEdit ? 'updated' : 'added'} successfully! Scraping profile data...`, 'success');
            closeCompetitorModal();
            setTimeout(() => location.reload(), 2000);
        } else {
            showToast('Error saving competitor: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Connection error. Please try again.', 'error');
        console.error('Error:', error);
    })
    .finally(() => {
        button.innerHTML = originalHTML;
        button.disabled = false;
    });
}

// Refresh competitor data
function refreshCompetitor(competitorId) {
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    showToast('Refreshing competitor data...', 'info');
    
    fetch(`/api/competitors/${competitorId}/refresh`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Competitor data refreshed successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('Error refreshing data: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Connection error. Please try again.', 'error');
        console.error('Error:', error);
    })
    .finally(() => {
        button.innerHTML = originalHTML;
        button.disabled = false;
    });
}

// Scrape competitor posts
function scrapeCompetitorPosts(competitorId) {
    if (confirm('This will scrape the latest posts from this competitor using Apify. Continue?')) {
        const button = event.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        showToast('Scraping competitor posts... This may take a few minutes.', 'info');
        
        fetch(`/api/competitors/${competitorId}/scrape-posts`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Successfully scraped ${data.posts_count} posts!`, 'success');
                // Optionally redirect to competitor details
                setTimeout(() => {
                    window.location.href = `/competitors/${competitorId}/details`;
                }, 2000);
            } else {
                if (data.action === 'configure_token') {
                    showToast('Apify token required. Please configure in Settings.', 'warning');
                } else {
                    showToast('Error scraping posts: ' + data.error, 'error');
                }
            }
        })
        .catch(error => {
            showToast('Connection error. Please try again.', 'error');
            console.error('Error:', error);
        })
        .finally(() => {
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }
}

// Refresh all competitors
function refreshAllCompetitors() {
    if (confirm('This will refresh data for all competitors. This may take several minutes. Continue?')) {
        const button = event.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...';
        button.disabled = true;
        
        showToast('Refreshing all competitor data... This may take a few minutes.', 'info');
        
        fetch('/api/competitors/refresh-all', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Successfully refreshed ${data.updated_count} competitors!`, 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('Error refreshing competitors: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Connection error. Please try again.', 'error');
            console.error('Error:', error);
        })
        .finally(() => {
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }
}

// View insights
function viewInsights(competitorId) {
    // Load insights content
    fetch(`/api/competitors/${competitorId}/insights`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('insightsTitle').textContent = `Insights: ${data.competitor.name}`;
            
            const content = `
                <div class="space-y-6">
                    <!-- Growth Chart -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-3">Growth Trends</h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-lg font-semibold text-blue-600">${data.insights.growth_metrics.connections_growth}%</div>
                                <div class="text-sm text-gray-600">Connections Growth</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold text-green-600">${data.insights.growth_metrics.followers_growth}%</div>
                                <div class="text-sm text-gray-600">Followers Growth</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold text-purple-600">${data.insights.growth_metrics.activity_growth}%</div>
                                <div class="text-sm text-gray-600">Activity Growth</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Analysis -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Content Strategy Analysis</h4>
                        <div class="space-y-3">
                            ${data.insights.content_analysis.map(insight => `
                                <div class="flex items-start space-x-3">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                                    <div class="text-gray-700">${insight}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Recommendations -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Strategic Recommendations</h4>
                        <div class="space-y-3">
                            ${data.insights.recommendations.map(rec => `
                                <div class="flex items-start space-x-3">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                                    <div class="text-gray-700">${rec}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('insightsContent').innerHTML = content;
            document.getElementById('insightsModal').classList.remove('hidden');
        } else {
            showToast('Error loading insights: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Connection error. Please try again.', 'error');
        console.error('Error:', error);
    });
}

// Edit competitor
function editCompetitor(competitorId) {
    // Load competitor data and populate modal
    fetch(`/api/competitors/${competitorId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const competitor = data.competitor;
            document.getElementById('competitorModalTitle').textContent = 'Edit Competitor';
            document.getElementById('competitorId').value = competitor.id;
            document.getElementById('competitorUrl').value = competitor.linkedin_url;
            document.getElementById('competitorName').value = competitor.name;
            document.getElementById('competitorCategory').value = competitor.category;
            document.getElementById('competitorPriority').value = competitor.priority;
            document.getElementById('competitorNotes').value = competitor.notes;
            document.getElementById('competitorModal').classList.remove('hidden');
        }
    });
}

// Delete competitor
function deleteCompetitor(competitorId) {
    if (confirm('Are you sure you want to remove this competitor from tracking?')) {
        fetch(`/api/competitors/${competitorId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Competitor removed successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error removing competitor: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Connection error. Please try again.', 'error');
            console.error('Error:', error);
        });
    }
}

// Export competitors
function exportCompetitors() {
    showToast('Exporting competitor analysis...', 'info');
    
    fetch('/api/competitors/export')
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `competitor-analysis-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        showToast('Competitor analysis exported successfully!', 'success');
    })
    .catch(error => {
        showToast('Export failed. Please try again.', 'error');
        console.error('Error:', error);
    });
}

// Toast notification function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    const bgColors = {
        success: 'bg-green-500',
        error: 'bg-red-500', 
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
    };
    
    toast.className = `fixed top-4 right-4 z-50 ${bgColors[type] || bgColors.info} text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 300);
    }, 4000);
}
</script>
{% endblock %}