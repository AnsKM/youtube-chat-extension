{% extends "base.html" %}

{% block title %}Competitor Posts Feed - LinkedIn Personal Branding{% endblock %}

{% block header %}Competitor Posts Feed{% endblock %}
{% block subtitle %}Monitor all COMPETITOR activity in one unified feed (separate from your own posts){% endblock %}

{% block content %}

<!-- Back Navigation -->
<div class="mb-6">
    <a href="/competitors" class="inline-flex items-center text-blue-600 hover:text-blue-800">
        <i class="fas fa-arrow-left mr-2"></i>
        Back to Competitor Analysis
    </a>
</div>

<!-- Filters and Controls -->
<div class="bg-white border border-gray-200 rounded-lg p-6 mb-8">
    <div class="flex flex-wrap justify-between items-center gap-4">
        <!-- Competitor Filter -->
        <div class="flex items-center space-x-4">
            <label class="text-sm font-medium text-gray-700">Filter by Competitor:</label>
            <select id="competitorFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="applyFilters()">
                <option value="all" {{ 'selected' if current_competitor_filter == 'all' else '' }}>All Competitors</option>
                {% for competitor in competitors %}
                <option value="{{ competitor.id }}" {{ 'selected' if current_competitor_filter == competitor.id else '' }}>
                    {{ competitor.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Time Filter -->
        <div class="flex items-center space-x-4">
            <label class="text-sm font-medium text-gray-700">Time Range:</label>
            <select id="timeFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="applyFilters()">
                <option value="1d" {{ 'selected' if current_time_filter == '1d' else '' }}>Last 24 Hours</option>
                <option value="7d" {{ 'selected' if current_time_filter == '7d' else '' }}>Last 7 Days</option>
                <option value="30d" {{ 'selected' if current_time_filter == '30d' else '' }}>Last 30 Days</option>
                <option value="all" {{ 'selected' if current_time_filter == 'all' else '' }}>All Time</option>
            </select>
        </div>
        
        <!-- Results Count -->
        <div class="flex items-center space-x-2">
            <span class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded">
                {{ posts|length }} posts
            </span>
        </div>
    </div>
</div>

<!-- Posts Feed -->
<div class="space-y-6">
    {% if posts %}
        {% for post in posts %}
        <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
            <!-- Post Header -->
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center space-x-4">
                    <!-- Competitor Avatar -->
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                        {{ post.competitor_info.name[:2].upper() }}
                    </div>
                    
                    <!-- Competitor Info -->
                    <div>
                        <div class="flex items-center space-x-2">
                            <h3 class="font-semibold text-gray-900">{{ post.competitor_info.name }}</h3>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                {{ post.competitor_info.category|title }}
                            </span>
                        </div>
                        <div class="text-sm text-gray-500">
                            {{ post.created_date[:10] }} at {{ post.created_date[11:16] }}
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex items-center space-x-2">
                    <a href="/competitors/{{ post.competitor_info.id }}/details" class="text-blue-600 hover:text-blue-800 p-2" title="View Competitor Details">
                        <i class="fas fa-user"></i>
                    </a>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        {{ post.platform|title }}
                    </span>
                </div>
            </div>
            
            <!-- Post Content -->
            <div class="mb-4">
                <div class="post-content text-gray-700 leading-relaxed">
                    {% if post.content|length > 300 %}
                        <div id="preview-{{ post.id }}" class="post-preview">
                            {{ (post.content[:300] + '...')|replace('\n', '<br>')|safe }}
                            <button onclick="toggleContent('{{ post.id }}')" class="text-blue-600 hover:text-blue-800 ml-2">
                                Show more
                            </button>
                        </div>
                        <div id="full-{{ post.id }}" class="post-full hidden">
                            {{ post.content|replace('\n', '<br>')|safe }}
                            <button onclick="toggleContent('{{ post.id }}')" class="text-blue-600 hover:text-blue-800 ml-2">
                                Show less
                            </button>
                        </div>
                    {% else %}
                        {{ post.content|replace('\n', '<br>')|safe }}
                    {% endif %}
                </div>
            </div>
            
            <!-- Post Tags -->
            {% if post.tags %}
            <div class="flex flex-wrap gap-2 mb-4">
                {% for tag in post.tags %}
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    #{{ tag }}
                </span>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Engagement Metrics -->
            <div class="border-t pt-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-6 text-sm text-gray-600">
                        <div class="flex items-center space-x-1">
                            <i class="fas fa-thumbs-up text-blue-500"></i>
                            <span>{{ post.engagement.likes }}</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <i class="fas fa-comment text-green-500"></i>
                            <span>{{ post.engagement.comments }}</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <i class="fas fa-share text-purple-500"></i>
                            <span>{{ post.engagement.shares }}</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <i class="fas fa-eye text-gray-500"></i>
                            <span>{{ post.engagement.views }}</span>
                        </div>
                    </div>
                    
                    <div class="text-sm font-medium text-gray-700">
                        Engagement Rate: {{ ((post.engagement.likes + post.engagement.comments + post.engagement.shares) / post.engagement.views * 100)|round(1) if post.engagement.views > 0 else 0 }}%
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <!-- Empty State -->
        <div class="bg-white border border-gray-200 rounded-lg p-12 text-center">
            <i class="fas fa-stream text-4xl text-gray-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No posts found</h3>
            <p class="text-gray-600 mb-6">
                {% if current_competitor_filter != 'all' %}
                    This competitor hasn't posted recently, or their posts haven't been scraped yet.
                {% else %}
                    No competitor posts found for the selected time range. Try scraping posts from individual competitors first.
                {% endif %}
            </p>
            <div class="flex justify-center space-x-4">
                <a href="/competitors" class="btn-primary">
                    <i class="fas fa-users mr-2"></i>
                    Manage Competitors
                </a>
                {% if current_competitor_filter != 'all' %}
                <button onclick="scrapeCompetitorPosts('{{ current_competitor_filter }}')" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors">
                    <i class="fas fa-newspaper mr-2"></i>
                    Scrape Posts
                </button>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<!-- Load More Button (for future pagination) -->
{% if posts|length >= 20 %}
<div class="mt-8 text-center">
    <button class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors">
        <i class="fas fa-arrow-down mr-2"></i>
        Load More Posts
    </button>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Apply filters
function applyFilters() {
    const competitorFilter = document.getElementById('competitorFilter').value;
    const timeFilter = document.getElementById('timeFilter').value;
    
    const url = new URL(window.location);
    url.searchParams.set('competitor', competitorFilter);
    url.searchParams.set('time', timeFilter);
    
    window.location.href = url.toString();
}

// Toggle post content
function toggleContent(postId) {
    const preview = document.getElementById(`preview-${postId}`);
    const full = document.getElementById(`full-${postId}`);
    
    if (preview.classList.contains('hidden')) {
        preview.classList.remove('hidden');
        full.classList.add('hidden');
    } else {
        preview.classList.add('hidden');
        full.classList.remove('hidden');
    }
}

// Scrape competitor posts
function scrapeCompetitorPosts(competitorId) {
    if (confirm('This will scrape the latest posts from this competitor. Continue?')) {
        showToast('Scraping competitor posts... This may take a few minutes.', 'info');
        
        fetch(`/api/competitors/${competitorId}/scrape-posts`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Successfully scraped ${data.posts_count} posts!`, 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                if (data.action === 'configure_token') {
                    showToast('Apify token required. Please configure in Settings.', 'warning');
                } else {
                    showToast('Error scraping posts: ' + data.error, 'error');
                }
            }
        })
        .catch(error => {
            showToast('Connection error. Please try again.', 'error');
            console.error('Error:', error);
        });
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    const bgColors = {
        success: 'bg-green-500',
        error: 'bg-red-500', 
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
    };
    
    toast.className = `fixed top-4 right-4 z-50 ${bgColors[type] || bgColors.info} text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 300);
    }, 4000);
}
</script>
{% endblock %}